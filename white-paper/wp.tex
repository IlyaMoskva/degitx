\documentclass[12pt,oneside]{article}
\usepackage[utf8]{inputenc}
\usepackage{float}
\usepackage[bottom]{footmisc}
\usepackage{bookmark}
\usepackage{microtype}
\usepackage{amsmath}
\usepackage{multicol}
\usepackage{mdframed}
\usepackage{setspace}
\usepackage{pgfplots}
\usepackage{graphicx}
\usepackage{fancyvrb}
\usepackage[absolute]{textpos}\TPGrid{16}{16}
\usepackage{tikz}
  \usetikzlibrary{shapes}
  \usetikzlibrary{arrows.meta}
  \usetikzlibrary{arrows}
  \usetikzlibrary{shadows}
  \usetikzlibrary{trees}
  \usetikzlibrary{fit}
  \usetikzlibrary{calc}
  \usetikzlibrary{positioning}
  \usetikzlibrary{decorations.pathmorphing}
\usepackage{./tikz-uml}
\usepackage{everypage}
  \AddEverypageHook{
    \begin{textblock}{0.5}[0,0](0,0)
      \tikz \node[fill=myred,minimum width=0.5\TPHorizModule,minimum height=16\TPVertModule] {};
    \end{textblock}
    \begin{textblock}{0.125}[0,0](0.5,0)
      \tikz \node[fill=myblack,inner sep=0, minimum width=0.125\TPHorizModule,minimum height=16\TPVertModule] {};
    \end{textblock}
  }
\usepackage{xcolor}
  \definecolor{firebrick}{HTML}{B22222}
  \definecolor{myred}{HTML}{CF0A2C}
  \definecolor{myblack}{HTML}{232527}
\newcommand\dd[1]{\colorbox{gray!30}{\texttt{#1}}}
\usepackage{hyperref}
  \hypersetup{colorlinks=true,allcolors=blue!40!black}
\setlength{\topskip}{6pt}
\setlength{\parindent}{0pt} % indent first line
\setlength{\parskip}{6pt} % before par
% \let\oldsection\section\renewcommand\section{\newpage\oldsection}
\date{\small\today}
\title{%
  DRAFT: Distributed git repository manager\\
  \colorbox{firebrick}{\small\sffamily\color{white}{White Paper}}}
\usepackage[style=authoryear,sorting=nyt,backend=biber,
  hyperref=true,abbreviate=true,
  maxcitenames=1,maxbibnames=1]{biblatex}
  \renewbibmacro{in:}{}
  \addbibresource{books.bib}
\tikzset{node distance=1.6cm, auto, every text node part/.style={align=center, font={\sffamily\small}}}
\tikzstyle{block} = [draw=myblack, fill=white, inner sep=0.3cm, outer sep=0.1cm, thick]
\tikzstyle{ln} = [draw, ->, very thick, arrows={-triangle 90}, every text node part/.append style={font={\sffamily\scriptsize}}]
\begin{document}
\raggedbottom

\maketitle
\begin{abstract}
Big software compines may have millions of code repositories,
and use them extensively by programmers and CI pipelines.
One git server is not able to satisfy performance expectations,
many servers with load-balancing can't solve this issue too because
of inability storage IO scaling for read operations.
Also, a big company may have distributed teams around the world,
where each team collaborates with others in one git repo,
cross-region repo access could be slow in such cases.
The solution for this problem is distributed git repository storage,
which replicates repositories across region nodes.
\end{abstract}

% \onehalfspace

\section{The problem}

There was an attempt to implement POC distributed repository manager with
eventually consistency guarantee, but it fails because of two reasons:
1) fetch traffic correlates with push frequency because of huge amount of
CI systems involved in development process: each push event usually triggers
CI build which clones the repository.
2) push and fetch frequency is not distributed uniformly over the time: in each
repository, team members may have different responsibilities for review and merge process,
project technical lead can merge all approved pull-requests in short period of time
which causes frequent push operations in git repo.

These two conditions leads to high fetch traffic peaks for git repositories:
frequent push operations turns replication nodes into inconsistent state,
and leads to high fetch traffic from different regions to primary repository node
which can shutdown the node and becomes the whole repository unavailable for some time.

Merge is not the only way to "update" the repository. Lots of activities can do that,
here is the list of some:

\begin{description}
  \item Create or delete branches by git push or by using web page.
  \item Create or delete tags by git push or by releasing new version on web page.
  \item Developer can update feature branches byself, it can also triggers CI builds.
  \item Tag could be updated using git push.
  \item Special REF create/update: on GitLab, when new merge request is created,
    the new \texttt{refs/merge-requests/IID/head} named ref
    is created. When source branch of merge request is updated, the ref is also updated.
  \item Migrations: sometimes repository administrator can migrate source code to
    another phisical device, it also could be treated as an update.
\end{description}

\section{Solution}

The solution could be the implementation of distributed Git repository manager with
replica nodes in regions and with strong consistency.
GitHub announced \href{https://github.blog/2016-04-05-introducing-dgit/}{DGit}
in 2016 (renamed to \href{https://github.blog/2016-09-07-building-resilience-in-spokes/}{Spokes})
where they \href{https://github.blog/2016-09-07-building-resilience-in-spokes/#defining-resilience}{pay attention}
to the consistency:
\begin{quote}
Spokes puts the highest priority on consistency and partition tolerance.
In worst-case failure scenarios, it will refuse to accept writes that it cannot commit,
synchronously, to at least two replicas.
\end{quote}

?It could be implemented using \href{https://raft.github.io/raft.pdf}{Raft} algorithm

TODO: add more

\section{Requirements}
\label{sec:requirements}

\subsection{Features}
\label{sec:features}

The most critical
\href{https://en.wikipedia.org/wiki/Non-functional_requirement}{Non-functional requirements}
are:

\begin{description}
  \item[Read scalability]
    The solution should scale out the read capacity of a system, each region should be able
    to access repository without connecting to master repo frequently.
  \item[Strong consistency]
    All? active replica repositories should be synchronized on updates in master node
    with immediate consistency.
  \item[Durability]
    The system must have enough replicas to recover itself in case of curruption.
    Corrupted repository could be reposnsible to recover itself using replica nodes.
  \item[Self management (rename?)]
    Each node performs cleanup when needed (\texttt{git gc}) and may remove replica
    from storage on read inactivity.
    A node shold be able to find and synchronize new repository on read,
    after that it should be up to date on new updates.
  \item[Maintainability]
    Node administrator can change the storage, and perform data migration from one storage
    to another.
    Repository administrators are able to add or delete node for new region and
    get all nodes status for repository.
  \item[Auditability]
    Node doesn't perform access control operations, but logs all
    requests with identity and performed operation.
  \item[Analytics]
    Node collects statistics for each repository and usage metrics, such as
    push and pull operations, etc. The system keeps the whole statistics about
    nodes, e.g. how many nodes contains each repository, the state of nodes, etc.
\end{description}

\subsection{Functional Requirements}
\label{sec:nfr}

The most important \href{https://en.wikipedia.org/wiki/Functional_requirement}{functional requirements} are:

\begin{description}
  \item[Front end]
    The system potentically may have different kinds of front-ends,
    but it's required to support \href{https://grpc.io/}{gRPC}
    of \href{https://about.gitlab.com/}{GitLab} to integrate the system
    into GitLab service and replace
    \href{https://docs.gitlab.com/ee/administration/gitaly/}{Gitaly}.
  \item[Back end]
    Each node may be connected to different types of storage for git repos,
    but it's required to support file-system storage.
\end{description}

\subsection{Expected Metrics}
\label{ref:metrics}

In a large enterprise it is expected to have the following
numbers, in terms of load, size, and speed:

\begin{tabular}{ll}
  Repositories & 2M \\
  Active users & 100K/day \\
  Merges & 100K/day \\
  Fetches & 15M/day, 15K/m - peak \\
  Push & 200K/day \\
  Traffic - download & 200Tb/day \\
  Traffic - update & 250Gb/day \\
\end{tabular}

\printbibliography%
\end{document}
